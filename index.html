<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Story Studio</title>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #0b1220;
      color: white;
    }

    header {
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      background: #111c30;
    }

    .panel {
      padding: 15px;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      border-radius: 12px;
      border: none;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 8px;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }

    .storyCard {
      background: #1e293b;
      padding: 12px;
      border-radius: 14px;
      margin-top: 12px;
    }

    .storyCard h3 {
      margin: 0;
    }

    .charList {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      margin-top: 10px;
    }

    .char {
      text-align: center;
    }

    .char img {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat {
      height: 65vh;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 75%;
      padding: 12px;
      border-radius: 16px;
      font-size: 16px;
      white-space: pre-wrap;
    }

    .user {
      background: #2563eb;
      align-self: flex-end;
    }

    .bot {
      background: #1e293b;
      align-self: flex-start;
    }

    .inputBox {
      display: flex;
      padding: 10px;
      background: #111c30;
    }

    .inputBox input {
      flex: 1;
      margin: 0;
      border-radius: 14px;
    }

    .inputBox button {
      width: 80px;
      margin-left: 8px;
      background: #22c55e;
    }
  </style>
</head>

<body>

<header>üìñ Chat Story Studio</header>

<div id="screen"></div>

<script>
/* -------------------------------
   –•–†–ê–ù–ï–ù–ò–ï –ò–°–¢–û–†–ò–ô
--------------------------------*/
let stories = JSON.parse(localStorage.getItem("stories") || "[]");
let currentStory = null;

function saveStories() {
  localStorage.setItem("stories", JSON.stringify(stories));
}

/* -------------------------------
   –ì–õ–ê–í–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –ê–í–¢–û–†–ê
--------------------------------*/
function renderAuthorPanel() {
  document.getElementById("screen").innerHTML = `
    <div class="panel">

      <h2>–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</h2>

      <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏">

      <textarea id="plot" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò)"></textarea>

      <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
      <input id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
      <input id="charRole" placeholder="–†–æ–ª—å (–¥—Ä—É–≥, –º–∞–º–∞, –≤—Ä–∞–≥)">
      <input id="charMood" placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä (—Å—Ç–µ—Ä–≤–∞, –¥–æ–±—Ä—ã–π)">
      <input id="charAvatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä">

      <button onclick="addCharacter()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>

      <div class="charList" id="charList"></div>

      <button onclick="saveStory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

      <hr>

      <h2>–í–∞—à–∏ –∏—Å—Ç–æ—Ä–∏–∏</h2>
      ${stories.map((s,i)=>`
        <div class="storyCard">
          <h3>${s.title}</h3>
          <p>${s.plot.slice(0,80)}...</p>
          <button onclick="startStory(${i})">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
          <button style="background:#dc2626" onclick="deleteStory(${i})">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `).join("")}

    </div>
  `;

  renderCharacters([]);
}

let tempCharacters = [];

function addCharacter() {
  let name = charName.value.trim();
  let role = charRole.value.trim();
  let mood = charMood.value.trim();
  let avatar = charAvatar.value.trim();

  if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");

  tempCharacters.push({name, role, mood, avatar});
  renderCharacters(tempCharacters);

  charName.value="";
  charRole.value="";
  charMood.value="";
  charAvatar.value="";
}

function renderCharacters(chars) {
  let list = document.getElementById("charList");
  if (!list) return;
  list.innerHTML = chars.map(c=>`
    <div class="char">
      <img src="${c.avatar || "https://via.placeholder.com/55"}">
      <p>${c.name}</p>
    </div>
  `).join("");
}

function saveStory() {
  let title = document.getElementById("title").value.trim();
  let plot = document.getElementById("plot").value.trim();

  if (!title || !plot) return alert("–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—é–∂–µ—Ç!");

  stories.push({
    title,
    plot,
    characters: tempCharacters,
    messages: []
  });

  tempCharacters = [];
  saveStories();
  renderAuthorPanel();
}

/* -------------------------------
   –£–î–ê–õ–ï–ù–ò–ï
--------------------------------*/
function deleteStory(i) {
  stories.splice(i,1);
  saveStories();
  renderAuthorPanel();
}

/* -------------------------------
   –ó–ê–ü–£–°–ö –ß–ê–¢–ê
--------------------------------*/
function startStory(i) {
  currentStory = stories[i];
  renderChat();
}

function renderChat() {
  document.getElementById("screen").innerHTML = `
    <div class="chat" id="chatBox"></div>

    <div class="inputBox">
      <input id="userInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button onclick="sendMessage()">‚û§</button>
    </div>

    <button onclick="renderAuthorPanel()">‚¨Ö –ù–∞–∑–∞–¥</button>
  `;

  updateChat();
}

function updateChat() {
  let box = document.getElementById("chatBox");
  box.innerHTML = currentStory.messages.map(m=>`
    <div class="msg ${m.role}">
      ${m.text}
    </div>
  `).join("");
  box.scrollTop = box.scrollHeight;
}

/* -------------------------------
   –û–¢–ü–†–ê–í–ö–ê –í –ò–ò
--------------------------------*/
async function sendMessage() {
  let input = document.getElementById("userInput");
  let text = input.value.trim();
  if (!text) return;

  currentStory.messages.push({role:"user", text});
  input.value="";
  updateChat();

  try {
    let res = await fetch("https://chat-horror-api.onrender.com/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        plot: currentStory.plot,
        characters: currentStory.characters,
        message: text
      })
    });

    let data = await res.json();

    currentStory.messages.push({role:"bot", text: data.reply});
    updateChat();

  } catch {
    currentStory.messages.push({role:"bot", text:"‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"});
    updateChat();
  }
}

renderAuthorPanel();
</script>

</body>
</html>
