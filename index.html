<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Story Studio</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#0f172a,#020617);
  color:white;
}

header{
  padding:20px;
  font-size:28px;
  font-weight:800;
  background:rgba(0,0,0,0.4);
  border-bottom:1px solid rgba(255,255,255,0.1);
}

.container{
  max-width:420px;
  margin:auto;
  padding:15px;
}

.card{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:18px;
  padding:15px;
  margin-top:15px;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  margin-top:10px;
  font-size:16px;
  font-weight:700;
  background:#2563eb;
  color:white;
  cursor:pointer;
}

button:hover{opacity:0.9;}

input,textarea,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(0,0,0,0.3);
  color:white;
  font-size:15px;
}

textarea{min-height:80px;}

.chatBox{
  margin-top:20px;
  padding:10px;
  background:rgba(255,255,255,0.03);
  border-radius:16px;
}

.msg{
  display:flex;
  gap:10px;
  margin:10px 0;
}

.avatar{
  width:45px;
  height:45px;
  border-radius:50%;
  object-fit:cover;
}

.bubble{
  background:rgba(255,255,255,0.08);
  padding:10px 14px;
  border-radius:16px;
  max-width:70%;
}

.you .bubble{
  background:#22c55e;
  margin-left:auto;
}

.choiceBox{
  margin-top:15px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,0,0,0.4);
}

.choiceBtn{
  background:#2563eb;
}
</style>
</head>

<body>

<header>Chat Story Studio</header>

<div class="container">

  <!-- –ò—Å—Ç–æ—Ä–∏–∏ -->
  <div class="card">
    <h2>üìö –ò—Å—Ç–æ—Ä–∏–∏</h2>
    <button onclick="newStory()">‚ûï –ù–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è</button>
    <div id="storiesList"></div>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
  <div class="card" id="editor" style="display:none;">
    <h2>‚úç –†–µ–¥–∞–∫—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏</h2>

    <input id="storyTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏">

    <select id="storyGenre">
      <option>–•–æ—Ä—Ä–æ—Ä</option>
      <option>–ú–∏—Å—Ç–∏–∫–∞</option>
      <option>–¢—Ä–∏–ª–ª–µ—Ä</option>
      <option>–î—Ä–∞–º–∞</option>
    </select>

    <h3>üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
    <input id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
    <input id="charImg" type="file" accept="image/*">
    <button onclick="addCharacter()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
    <div id="charList"></div>

    <h3>üí¨ –†–µ–ø–ª–∏–∫–∏ –∏ –≤—ã–±–æ—Ä—ã</h3>

    <select id="speakerSelect"></select>
    <textarea id="msgText" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>

    <button onclick="addLine()">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–ª–∏–∫—É</button>
    <button onclick="addEvent()">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
    <button onclick="addChoice()">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä —Å –≤–µ—Ç–∫–æ–π</button>

    <div id="storyPreview" class="chatBox"></div>

    <button onclick="saveStory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <button onclick="backHome()">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

</div>

<script>
let stories = JSON.parse(localStorage.getItem("stories")||"[]");
let currentStory=null;

function renderStories(){
  const box=document.getElementById("storiesList");
  box.innerHTML="";
  stories.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${s.title}</b><br>
      ${s.genre} ‚Ä¢ ${s.characters.length} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π<br>
      <button onclick="editStory(${i})">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    `;
    box.appendChild(div);
  });
}

function newStory(){
  currentStory={
    title:"",
    genre:"–•–æ—Ä—Ä–æ—Ä",
    characters:[],
    steps:[]
  };
  openEditor();
}

function editStory(i){
  currentStory=stories[i];
  openEditor();
}

function openEditor(){
  document.getElementById("editor").style.display="block";
  document.getElementById("storyTitle").value=currentStory.title;
  document.getElementById("storyGenre").value=currentStory.genre;
  renderCharacters();
  renderPreview();
}

function backHome(){
  document.getElementById("editor").style.display="none";
  renderStories();
}

function addCharacter(){
  const name=document.getElementById("charName").value.trim();
  const file=document.getElementById("charImg").files[0];
  if(!name||!file) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!");

  const reader=new FileReader();
  reader.onload=()=>{
    currentStory.characters.push({
      name,
      avatar:reader.result
    });
    renderCharacters();
  };
  reader.readAsDataURL(file);
}

function renderCharacters(){
  const list=document.getElementById("charList");
  const select=document.getElementById("speakerSelect");
  list.innerHTML="";
  select.innerHTML="";

  currentStory.characters.forEach(c=>{
    list.innerHTML+=`<div>‚Ä¢ ${c.name}</div>`;
    select.innerHTML+=`<option>${c.name}</option>`;
  });
}

function addLine(){
  const from=document.getElementById("speakerSelect").value;
  const text=document.getElementById("msgText").value.trim();
  if(!text) return;

  currentStory.steps.push({type:"line",from,text});
  document.getElementById("msgText").value="";
  renderPreview();
}

function addEvent(){
  const text=prompt("–°–æ–±—ã—Ç–∏–µ:");
  if(!text) return;
  currentStory.steps.push({type:"event",text});
  renderPreview();
}

function addChoice(){
  const question=prompt("–í–æ–ø—Ä–æ—Å –≤—ã–±–æ—Ä–∞:");
  const a=prompt("–í–∞—Ä–∏–∞–Ω—Ç 1:");
  const b=prompt("–í–∞—Ä–∏–∞–Ω—Ç 2:");
  if(!question||!a||!b) return;

  currentStory.steps.push({
    type:"choice",
    question,
    options:[
      {text:a,branch:[]},
      {text:b,branch:[]}
    ]
  });
  renderPreview();
}

function addBranchLine(choiceIndex,optIndex){
  const from=prompt("–ö—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç?");
  const text=prompt("–°–æ–æ–±—â–µ–Ω–∏–µ –≤–µ—Ç–∫–∏:");
  if(!from||!text) return;

  currentStory.steps[choiceIndex]
    .options[optIndex]
    .branch.push({from,text});

  renderPreview();
}

function renderPreview(){
  const box=document.getElementById("storyPreview");
  box.innerHTML="";

  currentStory.steps.forEach((s,i)=>{
    if(s.type==="line"){
      box.innerHTML+=`
        <div class="msg">
          <div class="bubble">
            <b>${s.from}:</b> ${s.text}
          </div>
        </div>
      `;
    }

    if(s.type==="event"){
      box.innerHTML+=`
        <div class="msg">
          <div class="bubble" style="background:rgba(255,255,255,0.15)">
            ‚ö° ${s.text}
          </div>
        </div>
      `;
    }

    if(s.type==="choice"){
      box.innerHTML+=`
        <div class="choiceBox">
          ‚ùì <b>${s.question}</b><br><br>

          1) ${s.options[0].text}
          <button onclick="addBranchLine(${i},0)">‚ûï –†–µ–ø–ª–∏–∫–∞ –≤–µ—Ç–∫–∏</button>
          (${s.options[0].branch.length})

          <br><br>

          2) ${s.options[1].text}
          <button onclick="addBranchLine(${i},1)">‚ûï –†–µ–ø–ª–∏–∫–∞ –≤–µ—Ç–∫–∏</button>
          (${s.options[1].branch.length})
        </div>
      `;
    }
  });
}

function saveStory(){
  currentStory.title=document.getElementById("storyTitle").value;
  currentStory.genre=document.getElementById("storyGenre").value;

  const index=stories.findIndex(s=>s===currentStory);
  if(index===-1) stories.push(currentStory);

  localStorage.setItem("stories",JSON.stringify(stories));
  alert("–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
  renderStories();
}

renderStories();
</script>

</body>
</html>
