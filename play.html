<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат истории</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #081a2b, #02060c);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      padding: 15px;
      gap: 10px;
    }

    header h1 {
      flex: 1;
      text-align: center;
      margin: 0;
      font-size: 22px;
    }

    .backBtn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 14px;
      cursor: pointer;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .msgRow {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      max-width: 85%;
    }

    .msgRow.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }

    .bubbleWrap {
      display: flex;
      flex-direction: column;
    }

    .name {
      font-size: 13px;
      opacity: 0.6;
      margin-bottom: 4px;
    }

    .bubble {
      background: rgba(255,255,255,0.07);
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 16px;
      line-height: 1.3;
      white-space: pre-wrap;
    }

    .user .bubble {
      background: #2563eb;
    }

    footer {
      display: flex;
      padding: 12px;
      gap: 10px;
    }

    input {
      flex: 1;
      padding: 14px;
      border-radius: 18px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    button.sendBtn {
      background: #22c55e;
      border: none;
      border-radius: 18px;
      padding: 0 18px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header>
  <button class="backBtn" onclick="goBack()">← Назад</button>
  <h1 id="storyTitle">История</h1>
</header>

<div id="chat"></div>

<footer>
  <input id="msgInput" placeholder="Сообщение...">
  <button class="sendBtn" onclick="sendMsg()">➤</button>
</footer>

<script>
/* ---------- Получаем историю ---------- */
const urlParams = new URLSearchParams(window.location.search);
const storyId = urlParams.get("id");

const stories = JSON.parse(localStorage.getItem("stories")) || [];
const story = stories.find(s => String(s.id) === String(storyId));

if (!story) {
  alert("История не найдена!");
  location.href = "index.html";
}

document.getElementById("storyTitle").innerText = story.title;

const characters = story.characters;
const chat = document.getElementById("chat");

/* ---------- Вспомогательное ---------- */
function avatarLetter(name) {
  return name.trim()[0].toUpperCase();
}

function addMessage(author, text, isUser=false) {
  const row = document.createElement("div");
  row.className = "msgRow" + (isUser ? " user" : "");

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.innerText = isUser ? "Я" : avatarLetter(author);

  const wrap = document.createElement("div");
  wrap.className = "bubbleWrap";

  const nameEl = document.createElement("div");
  nameEl.className = "name";
  nameEl.innerText = author;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerText = text;

  wrap.appendChild(nameEl);
  wrap.appendChild(bubble);

  row.appendChild(avatar);
  row.appendChild(wrap);

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function pickCharacter() {
  return characters[Math.floor(Math.random() * characters.length)];
}

/* ---------- Groq запрос ---------- */
async function askGroq(userText) {

  const message = `
Ты хоррор-чат игра.

История: ${story.desc}

Персонажи:
${characters.map(c => `- ${c.name}: ${c.role}`).join("\n")}

Правила:
- отвечай коротко (1-2 предложения)
- отвечай строго как персонаж
- иногда добавляй действие отдельной строкой: (что-то происходит)
- НЕ пиши длинные простыни

Игрок написал: "${userText}"

Ответ:
`;

  const res = await fetch("https://chat-horror-server.onrender.com/chat", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message })   // ✅ ВОТ ИСПРАВЛЕНО
  });

  const data = await res.json();
  return data.reply;
}

/* ---------- Старт ---------- */
addMessage("Система", "История начинается...");

setTimeout(() => {
  const first = pickCharacter();
  addMessage(first.name, "Я чувствую... здесь что-то не так.");
}, 800);


/* ---------- Отправка ---------- */
async function sendMsg() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text) return;

  addMessage("Вы", text, true);
  input.value = "";

  const char = pickCharacter();

  addMessage(char.name, "…");

  try {
    const reply = await askGroq(text);

    chat.removeChild(chat.lastChild);

    addMessage(char.name, reply);

  } catch (e) {
    chat.removeChild(chat.lastChild);
    addMessage("Система", "❌ Ошибка Groq API");
  }
}

function goBack() {
  location.href = "index.html";
}
</script>

</body>
</html>
