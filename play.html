<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò—Å—Ç–æ—Ä–∏—è</title>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: linear-gradient(#050b16, #000);
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      background: rgba(255,255,255,0.05);
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
    .msg {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      max-width: 85%;
    }

    .msg img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
    }

    .bubbleBlock {
      display: flex;
      flex-direction: column;
    }

    .name {
      font-size: 13px;
      opacity: 0.7;
      margin-bottom: 3px;
    }

    .bubble {
      background: rgba(255,255,255,0.08);
      padding: 12px;
      border-radius: 14px;
      font-size: 15px;
      line-height: 1.4;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ */
    .me {
      align-self: flex-end;
      text-align: right;
    }

    .me .bubble {
      background: #2979ff;
    }

    .me .name {
      text-align: right;
    }

    /* –í–≤–æ–¥ */
    footer {
      display: flex;
      padding: 10px;
      background: rgba(255,255,255,0.05);
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
    }

    button {
      margin-left: 10px;
      padding: 12px 18px;
      border: none;
      border-radius: 14px;
      background: #00c853;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header id="storyTitle">–ò—Å—Ç–æ—Ä–∏—è...</header>

<div id="chat"></div>

<footer>
  <input id="input" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
  <button onclick="sendMessage()">‚ñ∂</button>
</footer>

<script>
  const chat = document.getElementById("chat");

  /* –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é */
  const stories = JSON.parse(localStorage.getItem("stories") || "[]");
  const currentId = localStorage.getItem("currentStory");

  const story = stories.find(s => s.id == currentId);

  if (!story) {
    alert("–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
    location.href = "index.html";
  }

  document.getElementById("storyTitle").innerText = story.title;

  /* –ü–µ—Ä–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ */
  const mainCharacter = story.characters[0];

  /* –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è */
  function addMessage(author, text, avatar, isMe=false) {

    const msg = document.createElement("div");
    msg.className = "msg";

    if (isMe) msg.classList.add("me");

    msg.innerHTML = `
      ${isMe ? "" : `<img src="${avatar}">`}
      <div class="bubbleBlock">
        <div class="name">${author}</div>
        <div class="bubble">${text}</div>
      </div>
    `;

    if (isMe) {
      msg.innerHTML = `
        <div class="bubbleBlock">
          <div class="name">–í—ã</div>
          <div class="bubble">${text}</div>
        </div>
      `;
    }

    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  /* –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
  addMessage(
    mainCharacter.name,
    "–ü—Ä–∏–≤–µ—Ç... –¢—ã –≥–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é?",
    mainCharacter.avatar
  );

  /* –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–≥—Ä–æ–∫–∞ */
  async function sendMessage() {

    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text) return;

    addMessage("–í—ã", text, "", true);
    input.value = "";

    /* –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò */
    const prompt = `
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏.
–ò—Å—Ç–æ—Ä–∏—è: ${story.title}

–û–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞:
${story.desc}

–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:
${story.characters.map(c =>
`${c.name} (${c.role}) —Ö–∞—Ä–∞–∫—Ç–µ—Ä: ${c.traits}`
).join("\n")}

–ò–≥—Ä–æ–∫ –Ω–∞–ø–∏—Å–∞–ª: "${text}"

–û—Ç–≤–µ—Ç—å –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂ ${mainCharacter.name}, –ø—Ä–æ–¥–æ–ª–∂–∞—è —Å—é–∂–µ—Ç.
`;

    try {
      const res = await fetch("https://chat-horror-api.onrender.com/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: prompt })
      });

      const data = await res.json();

      addMessage(
        mainCharacter.name,
        data.reply,
        mainCharacter.avatar
      );

    } catch (err) {
      addMessage("–û—à–∏–±–∫–∞", "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç üò¢", "");
    }
  }
</script>

</body>
</html>
