<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Story Studio</title>

  <style>
    *{box-sizing:border-box;font-family:system-ui;}
    body{
      margin:0;
      background:linear-gradient(180deg,#05070c,#0a1020);
      color:white;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:14px;
      text-align:center;
      font-size:20px;
      font-weight:700;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .screen{
      flex:1;
      overflow:auto;
      padding:14px;
    }

    .card{
      background:rgba(255,255,255,0.06);
      padding:14px;
      border-radius:18px;
      margin-bottom:14px;
    }

    input,textarea{
      width:100%;
      padding:12px;
      margin-top:8px;
      border-radius:12px;
      border:none;
      outline:none;
      font-size:15px;
    }

    button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:14px;
      margin-top:10px;
      font-weight:700;
      cursor:pointer;
      background:#2563eb;
      color:white;
      font-size:16px;
    }

    .chat{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom:70px;
    }

    .msg{
      display:flex;
      gap:8px;
      max-width:85%;
      align-items:flex-end;
    }

    .bot{align-self:flex-start;}
    .user{align-self:flex-end;flex-direction:row-reverse;}

    .avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:#333;
      flex-shrink:0;
      overflow:hidden;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .bubble{
      padding:10px 14px;
      border-radius:16px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    .bot .bubble{
      background:rgba(255,255,255,0.08);
      border-bottom-left-radius:6px;
    }

    .user .bubble{
      background:#2563eb;
      border-bottom-right-radius:6px;
    }

    footer{
      display:flex;
      gap:8px;
      padding:10px;
      border-top:1px solid rgba(255,255,255,0.08);
      background:#05070c;
    }

    footer input{
      flex:1;
      margin:0;
    }

    footer button{
      width:auto;
      padding:0 18px;
      margin:0;
      background:#22c55e;
      color:black;
    }

    .small{
      opacity:0.6;
      font-size:13px;
      margin-top:4px;
    }
  </style>
</head>

<body>

<header>Chat Story Studio</header>

<div class="screen" id="screen"></div>

<script>
/* ===============================
   –î–ê–ù–ù–´–ï –ò–°–¢–û–†–ò–ò
================================ */

let story = {
  title: "",
  plot: "",
  characters: [],
};

/* ===============================
   –†–ï–ù–î–ï–† –ü–ê–ù–ï–õ–ò –ê–í–¢–û–†–ê
================================ */

function renderAuthorPanel(){
  screen.innerHTML = `
    <div class="card">
      <h2>üìñ –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∞</h2>

      <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏"
        value="${story.title}"/>

      <textarea id="plot" rows="4"
        placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞ (–ò–ò –±—É–¥–µ—Ç –æ—Ç —ç—Ç–æ–≥–æ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞—Ç—å—Å—è)">${story.plot}</textarea>

      <button onclick="saveStory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>

    <div class="card">
      <h2>üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>

      <input id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"/>

      <input type="file" id="charImg"/>

      <button onclick="addCharacter()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>

      <div class="small">
        ${story.characters.map(c=>`‚Ä¢ ${c.name}`).join("<br>")}
      </div>
    </div>

    <button onclick="startChat()">‚ñ∂ –ù–∞—á–∞—Ç—å —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏—é</button>
  `;
}

/* ===============================
   –°–û–•–†–ê–ù–ï–ù–ò–ï
================================ */

function saveStory(){
  story.title = document.getElementById("title").value;
  story.plot  = document.getElementById("plot").value;

  localStorage.setItem("story", JSON.stringify(story));
  alert("–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
}

/* ===============================
   –î–û–ë–ê–í–ò–¢–¨ –ü–ï–†–°–û–ù–ê–ñ–ê
================================ */

function addCharacter(){
  const name = document.getElementById("charName").value.trim();
  const file = document.getElementById("charImg").files[0];

  if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

  if(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      story.characters.push({name, avatar: reader.result});
      renderAuthorPanel();
    };
    reader.readAsDataURL(file);
  } else {
    story.characters.push({name, avatar: ""});
    renderAuthorPanel();
  }
}

/* ===============================
   –ß–ê–¢ –ò–ì–†–´
================================ */

function startChat(){
  if(!story.title) return alert("–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!");

  screen.innerHTML = `
    <h2>${story.title}</h2>
    <div class="small">${story.plot}</div>

    <div class="chat" id="chat"></div>

    <footer>
      <input id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
      <button onclick="send()">‚ñ∂</button>
    </footer>
  `;

  addMsg("–°—é–∂–µ—Ç –Ω–∞—á–∞–ª—Å—è... –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å.", "bot");
}

/* ===============================
   –î–û–ë–ê–í–ò–¢–¨ –°–û–û–ë–©–ï–ù–ò–ï
================================ */

function addMsg(text, who="bot"){
  const chat = document.getElementById("chat");

  const msg = document.createElement("div");
  msg.className = "msg " + who;

  const avatar = document.createElement("div");
  avatar.className="avatar";

  if(who==="bot" && story.characters[0]?.avatar){
    avatar.innerHTML=`<img src="${story.characters[0].avatar}">`;
  }

  const bubble = document.createElement("div");
  bubble.className="bubble";
  bubble.textContent=text;

  msg.appendChild(avatar);
  msg.appendChild(bubble);

  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

/* ===============================
   –û–¢–ü–†–ê–í–ö–ê –ù–ê RENDER API
================================ */

async function send(){
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if(!text) return;

  addMsg(text,"user");
  input.value="";

  addMsg("–ø–µ—á–∞—Ç–∞–µ—Ç...","bot");

  try{
    const res = await fetch("https://chat-horror-api.onrender.com/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        message: `
–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏—Å—Ç–æ—Ä–∏–∏.
–°—é–∂–µ—Ç –∞–≤—Ç–æ—Ä–∞: ${story.plot}

–ò–≥—Ä–æ–∫ –Ω–∞–ø–∏—Å–∞–ª: ${text}
–ü—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å—Ç–æ—Ä–∏—é –∂–∏–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
        `
      })
    });

    const data = await res.json();

    document.querySelector(".chat .bot:last-child").remove();
    addMsg(data.reply,"bot");

  }catch{
    document.querySelector(".chat .bot:last-child").remove();
    addMsg("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç","bot");
  }
}

/* ===============================
   –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò
================================ */

const saved = localStorage.getItem("story");
if(saved) story = JSON.parse(saved);

renderAuthorPanel();

</script>
</body>
</html>
