<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>История</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #081a2b, #02060c);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      padding: 15px;
      gap: 10px;
    }

    header h1 {
      flex: 1;
      text-align: center;
      margin: 0;
      font-size: 22px;
    }

    .backBtn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 14px;
      cursor: pointer;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .msgRow {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      max-width: 85%;
    }

    .msgRow.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      flex-shrink: 0;
    }

    .bubble {
      background: rgba(255,255,255,0.07);
      padding: 12px 14px;
      border-radius: 18px;
      font-size: 16px;
      line-height: 1.3;
    }

    .user .bubble {
      background: #2563eb;
    }

    .name {
      font-size: 13px;
      opacity: 0.6;
      margin-bottom: 4px;
    }

    .actionBubble {
      font-style: italic;
      opacity: 0.75;
      background: rgba(255,255,255,0.04);
    }

    footer {
      display: flex;
      padding: 12px;
      gap: 10px;
    }

    input {
      flex: 1;
      padding: 14px;
      border-radius: 18px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    button.sendBtn {
      background: #22c55e;
      border: none;
      border-radius: 18px;
      padding: 0 18px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header>
  <button class="backBtn" onclick="goBack()">← Назад</button>
  <h1 id="storyTitle">История</h1>
</header>

<div id="chat"></div>

<footer>
  <input id="msgInput" placeholder="Сообщение...">
  <button class="sendBtn" onclick="sendMsg()">➤</button>
</footer>

<script>
/* -------------------- Загрузка истории -------------------- */
const urlParams = new URLSearchParams(window.location.search);
const storyId = urlParams.get("id");

const stories = JSON.parse(localStorage.getItem("stories")) || [];
const story = stories.find(s => String(s.id) === String(storyId));

if (!story) {
  alert("История не найдена!");
  location.href = "index.html";
}

document.getElementById("storyTitle").innerText = story.title;

const characters = story.characters || [];

/* -------------------- Telegram сообщения -------------------- */
const chat = document.getElementById("chat");

function avatarLetter(name) {
  return name.trim()[0].toUpperCase();
}

function addMessage(author, text, isUser=false) {

  const row = document.createElement("div");
  row.className = "msgRow" + (isUser ? " user" : "");

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.innerText = isUser ? "Я" : avatarLetter(author);

  const bubbleWrap = document.createElement("div");

  const nameEl = document.createElement("div");
  nameEl.className = "name";
  nameEl.innerText = author;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerText = text;

  bubbleWrap.appendChild(nameEl);
  bubbleWrap.appendChild(bubble);

  row.appendChild(avatar);
  row.appendChild(bubbleWrap);

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

/* -------------------- Реплика действия -------------------- */
function addAction(author, actionText) {
  const row = document.createElement("div");
  row.className = "msgRow";

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.innerText = avatarLetter(author);

  const bubble = document.createElement("div");
  bubble.className = "bubble actionBubble";
  bubble.innerText = "(" + actionText + ")";

  row.appendChild(avatar);
  row.appendChild(bubble);

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

/* -------------------- AI Логика ролей -------------------- */
function pickCharacter() {
  return characters[Math.floor(Math.random() * characters.length)];
}

/* короткие реплики */
function shortReply(text) {
  return text.split(".")[0].slice(0, 80) + "...";
}

/* -------------------- Старт истории -------------------- */
addMessage("Система", "История начинается...");

setTimeout(() => {
  addAction("Система", "Темнота сгущается вокруг...");
}, 700);

setTimeout(() => {
  const first = pickCharacter();
  addMessage(first.name, "Привет... Всё начинается прямо сейчас.");
}, 1200);

/* -------------------- Отправка сообщения -------------------- */
async function sendMsg() {
  const input = document.getElementById("msgInput");
  const userText = input.value.trim();
  if (!userText) return;

  addMessage("Вы", userText, true);
  input.value = "";

  // персонаж отвечает строго по роли
  const char = pickCharacter();

  setTimeout(() => {
    addAction(char.name, `${char.role} внимательно реагирует...`);
  }, 600);

  setTimeout(() => {
    addMessage(char.name, shortReply("Я понимаю... Но здесь что-то не так."));
  }, 1200);
}

/* -------------------- Назад -------------------- */
function goBack() {
  location.href = "index.html";
}
</script>

</body>
</html>
